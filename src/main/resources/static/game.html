<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        canvas { border: 1px solid black; background-color: #fafafa; }
    </style>
</head>
<body>
<h2>ğŸ®Game</h2>
<select id="emojiSelect">
    <option value="ğŸ±">ğŸ±</option>
    <option value="ğŸš—">ğŸš—</option>
    <option value="ğŸ¦„">ğŸ¦„</option>
    <option value="ğŸŒŸ">ğŸŒŸ</option>
    <option value="ğŸ•">ğŸ•</option>
    <option value="ğŸ‰">ğŸ‰</option>
    <option value="ğŸ’»">ğŸ’»</option>
    <option value="ğŸ€">ğŸ€</option>
    <option value="âš½">âš½</option>
    <option value="ğŸ®">ğŸ®</option>
    <option value="ğŸµ">ğŸµ</option>
    <option value="ğŸŒˆ">ğŸŒˆ</option>
    <option value="ğŸŒ">ğŸŒ</option>
    <option value="ğŸŒ¸">ğŸŒ¸</option>
    <option value="ğŸ©">ğŸ©</option>
    <option value="ğŸ">ğŸ</option>
    <option value="ğŸ‰">ğŸ‰</option>
    <option value="ğŸ“">ğŸ“</option>
</select>
<input id="playerEmoji" type="text" placeholder="ä¾‹: ğŸ±, ğŸš—, ğŸ¦„">
<p id="onlineCount">ğŸŸ¢ ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: 0</p>
<p id="playerIdLabel">ã‚ãªãŸã®ID: <span id="playerId"></span></p>
<p id="score">Score: 0</p>
<div id="gameArea">
    <canvas id="canvas" width="800" height="400"></canvas>
    <div id="chatArea">
        <div id="chatMessages">
            <!-- èŠå¤©æ¶ˆæ¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <div id="chatInputArea">
            <input id="chatInput" type="text" placeholder="Type a message...">
            <button id="sendButton">Send</button>
        </div>
    </div>
</div>

<style>
    #gameArea {
        display: flex;
        align-items: start;
        justify-content: start;
        gap: 5rem;
    }

    #chatArea {
        display: flex;
        flex-direction: column;
        height: 400px;
        min-width: 500px;
        border: 1px solid #ccc;
        overflow-y: auto;
        border-radius: 5px;
    }

    #chatMessages {
        flex-grow: 1;
        border: 1px solid beige;
        overflow-y: auto;
        height: 300px;
        border-radius: 5px;
        margin-top: 5px;
        margin-bottom: 5px;
        padding: 10px;
    }

    .chat-message {
        padding: 8px 12px;
        border-radius: 10px;
        margin: 5px 0;
        color: #fff;
        max-width: 90%;          /* âœ… é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢è¶…å‡º */
        word-break: break-word;  /* âœ… å¼ºåˆ¶é•¿å•è¯æ¢è¡Œï¼ˆå¦‚ URL æˆ–é•¿æ–‡æœ¬ï¼‰ */
        white-space: pre-wrap;   /* âœ… ä¿ç•™ç©ºæ ¼å’Œæ¢è¡Œå¹¶è‡ªåŠ¨æ¢è¡Œ */
    }

    #chatInput {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: border-color 0.3s;
    }

    #chatInput:focus {
        border-color: #007BFF;
    }

    #sendButton {
        padding: 8px 16px;
        background-color: #007BFF;
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #sendButton:hover {
        background-color: #0056b3;
    }

</style>

<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const playerId = 'P' + Math.floor(Math.random() * 10000);
    let otherPlayers = {};
    const keys = {};
    document.getElementById("playerId").textContent = playerId;
    const items = [];  // æ‰€æœ‰é“å…·å¯¹è±¡
    let score = 0;

    const player = {
        id: playerId,
        x: 400,
        y: 200,
        size: 30,
        color: "blue",
        speed: 3,
        dx: 0,
        dy: 0,
        emoji: "ğŸ±"
    };

    function createRandomItem() {
        const item = {
            x: Math.random() * (canvas.width - 20) + 10,
            y: Math.random() * (canvas.height - 20) + 10,
            size: 20,
            emoji: "ğŸ", // ä½ å¯ä»¥ç”¨ä»»ä½• emoji
        };
        items.push(item);
    }

    window.addEventListener("keydown", function(e) {
        keys[e.key] = true;
        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) e.preventDefault();
    });

    window.addEventListener("keyup", function(e) {
        keys[e.key] = false;
    });

    function handleInput() {
        player.dx = 0;
        player.dy = 0;
        if (keys["ArrowLeft"]) player.dx = -player.speed;
        if (keys["ArrowRight"]) player.dx = player.speed;
        if (keys["ArrowUp"]) player.dy = -player.speed;
        if (keys["ArrowDown"]) player.dy = player.speed;
    }

    function updatePlayerPosition() {
        const input = document.getElementById("emojiSelect");
        const playerEmojiInput = document.getElementById("playerEmoji");
        if (input || playerEmojiInput) {
            player.emoji = playerEmojiInput.value || input.value || "ğŸ±";
        }
        player.x += player.dx;
        player.y += player.dy;
        const maxX = canvas.width;
        const maxY = canvas.height + player.size/2;
        player.x = Math.max(player.size/2, Math.min(player.x, maxX));
        player.y = Math.max(player.size/2, Math.min(player.y, maxY));
    }

    function drawPlayer(p) {
        ctx.font = "14px Arial";
        ctx.fillStyle = p.color;
        ctx.textAlign = "center";
        ctx.fillText(p.id, p.x, p.y - 30);
        ctx.font = player.size + "px serif";
        ctx.fillText(p.emoji || "ğŸ˜€", p.x, p.y);
    }

    function drawItems() {
        items.forEach(item => {
            ctx.font = item.size + "px serif";
            ctx.fillText(item.emoji, item.x, item.y);
        });
    }

    function drawScene() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawPlayer(player);
        drawItems();
        for (const id in otherPlayers) {
            if (id !== player.id) drawPlayer(otherPlayers[id]);
        }
    }

    function update() {
        handleInput();
        updatePlayerPosition();
        checkItemCollision();
        drawScene();
        requestAnimationFrame(update);
    }

    document.getElementById("chatInput").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault(); // é˜»æ­¢æ¢è¡Œ
            document.getElementById("sendButton").click(); // è§¦å‘ç‚¹å‡»äº‹ä»¶
        }
    });

    // WebSocket
    const socket = new SockJS("/ws");
    // ä½¿ç”¨ Stomp åè®®æ¥å¤„ç† WebSocket æ¶ˆæ¯
    const stompClient = Stomp.over(socket);
    stompClient.debug = null;

    // å»ºç«‹è¿æ¥åæ‰§è¡Œçš„å›è°ƒå‡½æ•°
    stompClient.connect({}, () => {

        // âœ… 1. è®¢é˜…å¹¿æ’­é¢‘é“ "/topic/players"
        //    æœåŠ¡å™¨ä¼šæŠŠæ‰€æœ‰ç©å®¶çš„ä½ç½®å¹¿æ’­åˆ°è¿™ä¸ªé¢‘é“
        stompClient.subscribe("/topic/players", message => {
            const playerList = JSON.parse(message.body);
            otherPlayers = {}; // æ¸…ç©ºåŸæœ‰
            playerList.forEach(p => {
                if (p.id !== player.id) {
                    otherPlayers[p.id] = p;
                }
            });
        });


        // âœ… 3. è®¢é˜… "/topic/messages" é¢‘é“
        //    æœåŠ¡å™¨ä¼šæŠŠèŠå¤©æ¶ˆæ¯å¹¿æ’­åˆ°è¿™ä¸ªé¢‘é“
        stompClient.subscribe("/topic/messages", message => {
            const chat = JSON.parse(message.body);
            const chatMessages = document.getElementById("chatMessages");

            const msgDiv = document.createElement("div");
            msgDiv.className = "chat-message";

            // ğŸŒˆ è®¾ç½®éšæœºèƒŒæ™¯è‰²
            const colors = ["#007BFF", "#28A745", "#FFC107", "#DC3545", "#17A2B8", "#6610f2", "#e83e8c"];
            const bgColor = colors[Math.floor(Math.random() * colors.length)];
            msgDiv.style.backgroundColor = bgColor;

            msgDiv.textContent = `${chat.sender}: ${chat.content}`;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // å‘é€èŠå¤©æ¶ˆæ¯çš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById("sendButton").addEventListener("click", () => {
            const chatInput = document.getElementById("chatInput");
            const content = chatInput.value.trim();
            if (content) {
                // å‘é€èŠå¤©æ¶ˆæ¯åˆ°æœåŠ¡å™¨
                stompClient.send("/app/chat", {}, JSON.stringify({
                    sender: player.id,
                    content: content
                }));
                chatInput.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
            }
        });

        // âœ… 2. æ¯éš” 20 æ¯«ç§’ï¼ˆå³æ¯ç§’ 50 æ¬¡ï¼‰ï¼Œå°†è‡ªå·±çš„ä½ç½®å‘é€ç»™æœåŠ¡å™¨
        //    è¿™æ ·æœåŠ¡å™¨å°±èƒ½å¹¿æ’­ä½ çš„ä½ç½®ç»™å…¶ä»–äºº
        setInterval(() => {
            // æŠŠè‡ªå·±å½“å‰çš„ player å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²å‘ç»™ "/app/move"
            stompClient.send("/app/move", {}, JSON.stringify(player));
        }, 20);
    });

    function checkItemCollision() {
        for (let i = items.length - 1; i >= 0; i--) {
            const item = items[i];
            const dx = player.x - item.x;
            const dy = player.y - item.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < (player.size / 2 + item.size / 2)) {
                items.splice(i, 1);  // åƒæ‰é“å…·
                score += 10;
                document.getElementById("score").textContent = `Score: ${score}`;
            }
        }
    }

    setInterval(() => {
        if (items.length < 5) {  // æœ€å¤š 5 ä¸ªé“å…·
            createRandomItem();
        }
    }, 3000);  // æ¯ 3 ç§’å°è¯•æ·»åŠ ä¸€ä¸ª

    setInterval(() => {
        fetch("/player/count")
            .then(res => res.text())
            .then(count => {
                document.getElementById("onlineCount").textContent = `ğŸŸ¢ ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${count}`;
            });
    }, 3000);

    update();
</script>
</body>
</html>
